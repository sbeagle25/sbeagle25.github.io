<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tooth Chart</title>
  <style>
    body {
      margin: 0;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }
    .chart {
      position: relative;
      background: url('svg_teeth.png') no-repeat center;
      background-size: contain;
      width: 917px;
      height: 308px;
      margin-top: 20px;
    }
    .tooth {
      position: absolute;
      width: 40px;
      height: 60px;
      cursor: pointer;
      background-color: rgba(255, 255, 0, 0.0);
      transition: background-color 0.3s;
    }
    #chart img {
      position: absolute;
      display: none;
      width: 40px;
      pointer-events: auto;
      user-select: none;
    }
    .controls {
      margin-top: 10px;
      font-family: sans-serif;
    }
    .controls button {
      margin-left: 10px;
    }
    #positionOutput {
      margin-top: 10px;
      white-space: pre;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      width: 90%;
      max-width: 1000px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
<div class="controls">
  拖曳植體圖示到正確位置後，可列出並下載座標。<br>
  <button onclick="resetTeeth()">全部還原</button>
  <button onclick="showPositions()">列出目前座標</button>
  <button onclick="downloadPositions()">下載座標</button>
  <button onclick="enterEditMode()">進入圖層調整模式</button>
</div>
<div class="chart" id="chart"></div>
<pre id="positionOutput"></pre>

<script>
const chart = document.getElementById('chart');
const toothData = [];

const topY = 40;
const bottomY = 200;
const spacing = 55;

for (let i = 0; i < 32; i++) {
  const number = i < 16 ? 18 - i : 31 + (i - 15);
  const left = 20 + (i % 16) * spacing;
  const top = i < 16 ? topY : bottomY;
  toothData.push({ id: number, top, left });
}

const implantImgs = {}, missingImgs = {}, bridgeImgs = {}, crownImgs = {}, toothDivs = {};

for (const t of toothData) {
  const div = document.createElement('div');
  div.className = 'tooth';
  div.style.top = t.top + 'px';
  div.style.left = t.left + 'px';
  div.dataset.state = 'normal';
  div.title = `Tooth ${t.id}`;

  const implantImg = document.createElement('img');
  implantImg.id = `implant-${t.id}`;
  implantImg.src = `implant/${t.id}i.png`;
  implantImg.style.top = t.top + 'px';
  implantImg.style.left = t.left + 'px';

  const missingImg = document.createElement('img');
  missingImg.id = `missing-${t.id}`;
  missingImg.src = `missing/${t.id}m.png`;
  missingImg.style.top = t.top + 'px';
  missingImg.style.left = t.left + 'px';

  const bridgeImg = document.createElement('img');
  bridgeImg.id = `bridge-${t.id}`;
  bridgeImg.src = `bridge/${t.id}b.png`;
  bridgeImg.style.top = t.top + 'px';
  bridgeImg.style.left = t.left + 'px';

  const crownImg = document.createElement('img');
  crownImg.id = `crown-${t.id}`;
  crownImg.src = `crown/${t.id}c.png`;
  crownImg.style.top = t.top + 'px';
  crownImg.style.left = t.left + 'px';

  implantImgs[t.id] = implantImg;
  missingImgs[t.id] = missingImg;
  bridgeImgs[t.id] = bridgeImg;
  crownImgs[t.id] = crownImg;
  toothDivs[t.id] = div;

  div.addEventListener('click', () => {
    const states = ['normal', 'implant', 'prosthetic', 'missing', 'crown'];
    const current = div.dataset.state;
    const next = states[(states.indexOf(current) + 1) % states.length];
    div.dataset.state = next;
    div.className = 'tooth';

    implantImg.style.display = 'none';
    missingImg.style.display = 'none';
    bridgeImg.style.display = 'none';
    crownImg.style.display = 'none';

    if (next === 'implant') implantImg.style.display = 'block';
    else if (next === 'missing') missingImg.style.display = 'block';
    else if (next === 'prosthetic') bridgeImg.style.display = 'block';
    else if (next === 'crown') crownImg.style.display = 'block';
  });

  chart.appendChild(div);
  chart.appendChild(implantImg);
  chart.appendChild(missingImg);
  chart.appendChild(bridgeImg);
  chart.appendChild(crownImg);
}

function resetTeeth() {
  for (const t of toothData) {
    toothDivs[t.id].dataset.state = 'normal';
    implantImgs[t.id].style.display = 'none';
    missingImgs[t.id].style.display = 'none';
    bridgeImgs[t.id].style.display = 'none';
    crownImgs[t.id].style.display = 'none';
  }
}

let draggingImg = null, offsetX = 0, offsetY = 0;

chart.addEventListener('mousedown', (e) => {
  if (e.target.tagName === 'IMG') {
    draggingImg = e.target;
    const rect = draggingImg.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
  }
});

chart.addEventListener('mousemove', (e) => {
  if (!draggingImg) return;
  const rect = chart.getBoundingClientRect();
  draggingImg.style.left = (e.clientX - rect.left - offsetX) + 'px';
  draggingImg.style.top = (e.clientY - rect.top - offsetY) + 'px';
});

chart.addEventListener('mouseup', () => {
  draggingImg = null;
});

function showPositions() {
  let output = '';
  document.querySelectorAll('#chart img').forEach(img => {
    output += `${img.id}: left: ${img.style.left}; top: ${img.style.top};\n`;
  });
  document.getElementById('positionOutput').textContent = output;
}

function downloadPositions() {
  let output = '';
  document.querySelectorAll('#chart img').forEach(img => {
    output += `${img.id}: left: ${img.style.left}; top: ${img.style.top};\n`;
  });
  const blob = new Blob([output], { type: 'text/plain' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'tooth_positions.txt';
  link.click();
}

function enterEditMode() {
  document.querySelectorAll('#chart img').forEach(img => {
    img.style.display = 'block';
    img.style.pointerEvents = 'auto';
  });
}
</script>
</body>
</html>
